name: Deploy CloudFormation and Microservices

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Clean AWS environment
        run: |
          rm -rf ~/.aws || true
          unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN AWS_REGION

      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Configure AWS OIDC Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::339495302685:role/github-ecr-role
          aws-region: ap-south-1
          role-session-name: GitHubActionsSession-${{ github.run_id }}
          role-duration-seconds: 3600

      - name: Validate CloudFormation Template
        run: aws cloudformation validate-template --template-body file://cloudformation.yml --region ap-south-1

      - name: Sanity check for forbidden properties
        run: |
          if grep -q AssociatePublicIpAddress cloudformation.yml; then
            echo "ERROR: Found forbidden AssociatePublicIpAddress property in template."
            exit 1
          fi

      - name: Deploy CloudFormation Stack
        run: |
          set -x
          echo "========= Deploying CloudFormation Stack ========="
          STACK_STATUS=$(aws cloudformation describe-stacks --stack-name microservices-stack --region ap-south-1 --query 'Stacks[0].StackStatus' --output text 2>/dev/null || echo "DELETE")
          if [ "$STACK_STATUS" = "ROLLBACK_COMPLETE" ]; then
            echo "Stack in ROLLBACK_COMPLETE. Deleting stack..."
            aws cloudformation delete-stack --stack-name microservices-stack --region ap-south-1
            aws cloudformation wait stack-delete-complete --stack-name microservices-stack --region ap-south-1
          fi
          aws cloudformation deploy \
            --stack-name microservices-stack \
            --template-file cloudformation.yml \
            --capabilities CAPABILITY_NAMED_IAM \
            --region ap-south-1 \
            --no-fail-on-empty-changeset \
            --force-upload \
            --parameter-overrides KeyName=cloudformationdeploy || (
            echo "Deployment failed. Showing stack CREATE_FAILED reasons:" ;
            aws cloudformation describe-stack-events --stack-name microservices-stack --region ap-south-1 --query "StackEvents[?ResourceStatus=='CREATE_FAILED'].{Resource:LogicalResourceId,Reason:ResourceStatusReason}" --output table ;
            exit 1 )
          echo "========= CloudFormation Deployment Complete ======"
          aws cloudformation describe-stacks --stack-name microservices-stack --region ap-south-1 \
            --query "Stacks[0].Outputs" --output table

      - name: Print CloudFormation Stack Events (Always)
        if: always()
        run: |
          echo "========= Printing last 20 CloudFormation stack events ========="
          aws cloudformation describe-stack-events \
            --stack-name microservices-stack \
            --region ap-south-1 \
            --query "StackEvents[0:20].[Timestamp,LogicalResourceId,ResourceType,ResourceStatus,ResourceStatusReason]" \
            --output table || echo "No events found (stack may not exist yet)."

      - name: Get EC2 Public DNS
        id: get-ec2-host
        run: |
          HOST=$(aws cloudformation describe-stacks \
            --stack-name microservices-stack \
            --region ap-south-1 \
            --query "Stacks[0].Outputs[?OutputKey=='EC2PublicDNS'].OutputValue" \
            --output text)
          echo "EC2_HOST=$HOST" >> $GITHUB_ENV
          echo "Detected EC2 Host: $HOST"

      - name: SSH and Deploy Containers with Secrets
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -ex
            echo "========= Changing to deployment-infra directory ========="
            cd /home/ec2-user/deployment-infra

            echo "========= Writing .env file ========="
            cat > .env <<EOF
            MYSQL_DB=${{ secrets.MYSQL_DB }}
            MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
            # Add more secrets as needed
            EOF
            echo "[INFO] .env file created with secrets"

            echo "========= Starting deploy.sh script ========="
            cd scripts
            chmod +x deploy.sh
            ./deploy.sh
            echo "[INFO] deploy.sh script execution completed"
